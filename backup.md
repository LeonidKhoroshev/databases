# Домашнее задание к занятию «Резервное копирование баз данных» - Леонид Хорошев


---

### Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. 

Необходимо описать, какие варианты резервного копирования подходят в случаях: 

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день - тут возможны варианты. В случае, если полный бэкап был осуществлен сравнительно недавно, то подойдет комбинация из полного бэкапа и инкрементных бэкапов, выполненных с момента полного резервного копирования до предыдущего дня включительно. Если полный бэкап выполнен достаточно давно, то следует применять комбинацию из полного резеравного копирования и дифференциального бэкапа, так как данная комбинация будет надежней, чем большое количество инкрементных бэкапов. 

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки - горячее резервирование (позволяет восстаннавливать данные до определенного момента времени). Создание резервной копии файлов пользователя происходит в интерактивном режиме по мере их изменения. Система сканирует указанные ей директории и переносит их в архив, после чего следит за происходящим в файловой системе и по мере обнаружения изменений также архивирует их. При данном подходе возможно некорректное отображение данных, так как при копировании содержимое базы данных может меняться, однако это единственный возможный вариант для восстановления информации в требуемые сроки (если только полный бэкап не был выполнен за час до поломки).

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных - возможен в случае наличия репликации (master-slave) и развертывания бэкапа со slave-сервера, так как время отставания slave от master-сервера незначительное.  По условиям задания мы имеем дело с финансовой компанией, это значит, что любая потеря данных не допускается. Следовательно требуется настроить синхронную репликацию (процесс дублирования данных в реальном времени через сеть таким образом, чтобы существовало несколько актуальных копий). Запись данных должна делаться одновременно в разные локации. Операция не завершится, пока данные не будут записаны и сохранены на другие копии. При этом оборудование, серверы, хранилища на точках также полностью идентичны для того, чтобы при переходе реплика могла справиться с той же нагрузкой, что и основная база.


---

### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

Резервное копирование базы данных с одного хоста на другой.

```sql
pg_dump -h hostname_1  | psql -h hostname_2 dbname
```

Восстановление базы данных из дамп-файла возможно двумя командами:

```sql
psql dbname < dump_file
```

```sql
pg_restore -U username -d dbname -v "dump_file"
```
dbname - база данных, чью резервную копию мы создаем.
dump_file - дамп файл, созданный в результате резервного копирования и из которого восстанавливается база данных.
hostdbnamename_1 - хост с нашей базой данных.
hostname_2 - хост, где мы создаем резервную копию.

Pg_restore от psql отличается при восстановлении базы тем, что psql используется при восстановлении дампа, сделанного в формате plain, а pg_restore — при восстановлении дампа, сделанного в других форматах.

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

Выполнить автоматизацию резервного копирования можно и даже нужно. Для этого нам необходим bash скрипт, выполняющий резервное копирование и утилита cron, которая запускает наш скрипт по указанному нами же расписанию.

```
#! /bin/sh
db_name=dbname
db_user=dbuser
db_host=host
backupfolder=~/postgresql/backups 
recipient_email=youremail@example.ru
# Сколько дней хранить файлы
keep_day=30
sqlfile=$backupfolder/database-$(date +%d-%m-%Y_%H-%M-%S).sql
zipfile=$backupfolder/database-$(date +%d-%m-%Y_%H-%M-%S).zip
mkdir -p $backupfolder

if pg_dump -U $db_user -h $db_host $db_name > $sqlfile ; then
   echo 'Sql dump created'
else
   echo 'pg_dump return non-zero code' | mailx -s 'No backup was created!' $recipient_email
   exit
fi

if gzip -c $sqlfile > $zipfile; then
   echo 'The backup was successfully compressed'
else
   echo 'Error compressing backup' | mailx -s 'Backup was not created!' $recipient_email
   exit
fi
rm $sqlfile 
echo $zipfile | mailx -s -a $sqlfile 'Backup was successfully created' $recipient_email
 
find $backupfolder -mtime +$keep_day -delete
```

Для корректной работы скрипта, его необходимо сделать исполняемым и создать файл pgpass.

```
chmod +x pg_backup.bash
```

```
nano  ~/.pgpass
# hostname:port:database:username:password
*:*:*:dbuser:dbpassword
```

```
chmod 600 ~/.pgpass
```

Далее настраиваем периодичность выполнения резервного копирования. Если мы хотим стандартный интервал, то необходимо переместить наш скрипт в одну из указанных директорий:
/etc/cron.minutely - копирование каждую минуту.
/etc/cron.hourly - копирование каждый час.
/etc/cron.daily - копирование каждый день.
/etc/cron.weekly - копирование каждую неделю.
/etc/cron.monthly - копирование каждый месяц.

Если требуется более точная настройка, то нам необходимо отредактировать файл /etc/crontab.

```
crontab -e
0 0 * * * /usr/local/bin/our_script.sh
```

Данный пример настраивает резервное копирование ежесуточно в полночь, но можно настроить любой интервал по следующему правилу:
минута час день месяц день_недели /путь/к/исполняемому/файлу.

---

### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL.

```sql
mysqlbackup --defaults-file=/home/dbadmin/my.cnf \
  --incremental --incremental-base=history:last_backup \
  --backup-dir=/home/dbadmin/temp_dir \
  --backup-image=incremental_image1.bi \
   backup-to-image
```

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

Репликация дает ощутимое преимущество в случае, когда необходимо свести к минимуму риски остановки работы сервисов и потери данных (при настроенной репликации инкрементное копирование осуществляется практически в режиме реального времени).  В случае отключения основного сервера (master), на втором хосте (slave) будет поднят точный аналог исходника, готовый к работе.


---
